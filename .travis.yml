---
dist: trusty
os: linux
language: ruby
cache: bundler
rvm:
  - 2.4.5
  - 2.5.8
  - 2.6.5
  - 2.7.1
  - ruby-head
gemfile:
  - gemfiles/rails_4.gemfile
  - gemfiles/rails_5.gemfile
  - gemfiles/rails_6.gemfile
jobs:
  fast_finish: false
  exclude:
    - gemfile: gemfiles/rails_5.gemfile
      rvm: 2.4.5
    - gemfile: gemfiles/rails_6.gemfile
      rvm: 2.4.5
  allow_failures:
    - rvm: ruby-head
install: |
  set -ex
  gem env
  gem list bundler
  echo y | rvm @global do gem install bundler -v 1.17.3 --force --default
  echo y | rvm @global do gem uninstall bundler -v 2.1.4 --force
  gem list bundler
  bundle --version
  bundle _1.17.3_ --version
  bundle install --jobs=3 --retry=3 --path=${BUNDLE_PATH:-vendor/bundle}
script:
  - bundle exec rake test:prepare_testapp[force]
  - bundle exec rake test:all < test_responses.txt
